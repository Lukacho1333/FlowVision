// Prisma schema for FlowVision
// AI-powered efficiency intelligence platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  passwordHash  String
  role          Role           @default(LEADER)
  name          String?
  image         String?
  emailVerified DateTime?
  preferences   Json?
  aiTier        String         @default("basic") // basic, premium, enterprise
  businessProfile BusinessProfile?
  initiatives   Initiative[]   @relation("UserInitiatives")
  comments      Comment[]
  ideas         Idea[]
  votes         Vote[]
  auditLogs     AuditLog[]
  attachments   Attachment[]
  assignedRequirementCards RequirementCard[] @relation("UserRequirementCards")
  createdRequirementCards  RequirementCard[] @relation("CreatedRequirementCards")
  approvedRequirementCards RequirementCard[] @relation("ApprovedRequirementCards")
  accounts      Account[]
  sessions      Session[]
  aiUsageLogs   AIUsageLog[]
  aiQuota       AIUserQuota?
  aiConfigurations AIConfiguration[]
  aiFeedback    AIQualityFeedback[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

enum Role {
  ADMIN
  LEADER
}

model BusinessProfile {
  id       String   @id @default(cuid())
  user     User     @relation(fields: [userId], references: [id])
  userId   String   @unique
  industry String
  size     Int
  metrics  Json
}

model Initiative {
  id             String        @id @default(cuid())
  title          String
  problem        String
  goal           String
  kpis           String[]
  requirements   String[]      @default([])
  acceptanceCriteria String[]  @default([])
  owner          User          @relation("UserInitiatives", fields: [ownerId], references: [id])
  ownerId        String
  timelineStart  DateTime?
  timelineEnd    DateTime?
  status         String
  progress       Int           @default(0)
  difficulty     Int?
  roi            Int?
  priorityScore  Int?
  orderIndex     Int           @default(0)
  budget         Int?
  estimatedHours Int?
  actualHours    Int?
  phase          String?       @default("planning")
  type           String?       @default("Process Improvement") // Process Improvement, Technology, Strategic, Operational, Quality, Cost Reduction
  cluster        IssueCluster? @relation("ClusterInitiatives", fields: [clusterId], references: [id])
  clusterId      String?
  addressedIssues Issue[]      @relation("IssueInitiatives") // Many-to-many with issues
  crossImpact    Json?         // Multi-departmental impact analysis
  clusterMetrics Json?         // Cluster-specific success metrics
  dependencies   Initiative[]  @relation("InitiativeDependencies")
  dependents     Initiative[]  @relation("InitiativeDependencies")
  milestones     Milestone[]
  assignments    ResourceAssignment[]
  comments       Comment[]
  ideas          Idea[]
  votes          Vote[]
  attachments    Attachment[]
  requirementCards RequirementCard[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model RequirementCard {
  id            String      @id @default(cuid())
  initiative    Initiative  @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  initiativeId  String
  type          String      @default("BUSINESS") // BUSINESS, FUNCTIONAL, ACCEPTANCE
  title         String
  description   String
  priority      String      @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  status        String      @default("DRAFT") // DRAFT, REVIEW, APPROVED, REJECTED
  category      String?     // Optional grouping
  assignedTo    User?       @relation("UserRequirementCards", fields: [assignedToId], references: [id])
  assignedToId  String?
  createdBy     User        @relation("CreatedRequirementCards", fields: [createdById], references: [id])
  createdById   String
  approvedBy    User?       @relation("ApprovedRequirementCards", fields: [approvedById], references: [id])
  approvedById  String?
  approvedAt    DateTime?
  orderIndex    Int         @default(0)
  // AI Generation Fields
  aiGenerated   Boolean     @default(false) // Whether generated by AI
  sourceType    String?     // 'issue', 'cluster', 'manual'
  sourceId      String?     // ID of source issue/cluster
  aiConfidence  Int?        // AI confidence score (0-100)
  comments      Comment[]
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

model Team {
  id          String              @id @default(cuid())
  name        String
  department  String?
  capacity    Int                 @default(40) // hours per week
  skills      String[]
  assignments ResourceAssignment[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
}

model Milestone {
  id           String     @id @default(cuid())
  title        String
  description  String?
  dueDate      DateTime
  status       String     @default("pending") // pending, in_progress, completed, delayed
  initiative   Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  initiativeId String
  progress     Int        @default(0)
  comments     Comment[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model ResourceAssignment {
  id           String     @id @default(cuid())
  initiative   Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  initiativeId String
  team         Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId       String
  hoursAllocated Int      @default(0)
  startDate    DateTime?
  endDate      DateTime?
  role         String?    // "lead", "contributor", "reviewer"
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([initiativeId, teamId])
}

model Issue {
  id            String        @id @default(cuid())
  description   String
  votes         Int           @default(0)
  heatmapScore  Int           @default(0)
  department    String?       // Added for clustering analysis
  category      String?       // Added for clustering analysis
  cluster       IssueCluster? @relation(fields: [clusterId], references: [id])
  clusterId     String?
  similarity    Json?         // Semantic similarity scores to other issues
  keywords      String[]      @default([]) // Extracted keywords for clustering
  crossImpact   Json?         // Cross-departmental impact analysis
  // AI Summary Fields
  aiSummary     String?       // AI-generated analysis and summary
  aiConfidence  Int?          // AI confidence score (0-100)
  aiGeneratedAt DateTime?     // When AI summary was created
  aiVersion     String?       // AI model version used
  comments      Comment[]
  userVotes     Vote[]
  initiatives   Initiative[]  @relation("IssueInitiatives") // Many-to-many with initiatives
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt @default(now())
}

model IssueCluster {
  id             String      @id @default(cuid())
  name           String      // e.g., "Project Coordination & Communication"
  description    String      // Detailed description of cluster theme
  category       String      // e.g., "coordination", "technology", "process"
  severity       String      @default("medium") // low, medium, high, critical
  theme          String      // Brief theme description
  keywords       String[]    @default([]) // Keywords used for clustering
  issues         Issue[]     // Related issues in this cluster
  initiatives    Initiative[] @relation("ClusterInitiatives") // Strategic initiatives addressing this cluster
  rootCauses     Json?       // AI-identified root causes
  impactAnalysis Json?       // Cross-departmental impact assessment
  metrics        Json?       // Cluster performance metrics
  // AI Summary Fields for Cluster
  aiSummary      String?     // AI-generated consolidated analysis across issues
  aiInsights     Json?       // Advanced AI insights (patterns, recommendations, etc.)
  aiConfidence   Int?        // AI confidence score (0-100)
  aiGeneratedAt  DateTime?   // When AI summary was created
  aiVersion      String?     // AI model version used
  color          String      @default("#3B82F6") // UI color for visualization
  isActive       Boolean     @default(true) // Whether cluster is actively used
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}

model Comment {
  id           String      @id @default(cuid())
  content      String
  author       User        @relation(fields: [authorId], references: [id])
  authorId     String
  initiative   Initiative? @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  initiativeId String?
  issue        Issue?      @relation(fields: [issueId], references: [id], onDelete: Cascade)
  issueId      String?
  idea         Idea?       @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  ideaId       String?
  milestone    Milestone?  @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  milestoneId  String?
  requirementCard RequirementCard? @relation(fields: [requirementCardId], references: [id], onDelete: Cascade)
  requirementCardId String?
  parentComment Comment?   @relation("CommentReplies", fields: [parentId], references: [id])
  parentId     String?
  replies      Comment[]   @relation("CommentReplies")
  mentions     String[]    // User IDs mentioned in comment
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

model Idea {
  id          String     @id @default(cuid())
  title       String
  description String
  author      User       @relation(fields: [authorId], references: [id])
  authorId    String
  category    String     @default("general") // general, process, technology, strategy
  priority    String     @default("medium") // low, medium, high
  status      String     @default("idea") // idea, reviewing, approved, rejected, implemented
  votes       Int        @default(0)
  tags        String[]
  assignedTo  String?    // User ID for assignment
  dueDate     DateTime?
  initiative  Initiative? @relation(fields: [initiativeId], references: [id])
  initiativeId String?
  userVotes   Vote[]
  comments    Comment[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Vote {
  id           String      @id @default(cuid())
  user         User        @relation(fields: [userId], references: [id])
  userId       String
  initiative   Initiative? @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  initiativeId String?
  idea         Idea?       @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  ideaId       String?
  issue        Issue?      @relation(fields: [issueId], references: [id], onDelete: Cascade)
  issueId      String?
  type         String      // up, down, priority
  value        Int         @default(1)
  createdAt    DateTime    @default(now())

  @@unique([userId, initiativeId])
  @@unique([userId, ideaId])
  @@unique([userId, issueId])
}

model AuditLog {
  id        String   @id @default(cuid())
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?
  action    String
  details   Json
  timestamp DateTime @default(now())
}

model Attachment {
  id           String     @id @default(cuid())
  filename     String
  filepath     String
  mimetype     String
  size         Int
  initiative   Initiative @relation(fields: [initiativeId], references: [id], onDelete: Cascade)
  initiativeId String
  uploadedBy   User       @relation(fields: [uploadedById], references: [id])
  uploadedById String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// NextAuth models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  oauth_token_secret String?
  oauth_token       String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// AI Optimization Models
model AIUsageLog {
  id           String   @id @default(cuid())
  requestId    String
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  operation    String
  inputTokens  Int      @default(0)
  outputTokens Int      @default(0)
  totalTokens  Int      @default(0)
  cost         Float    @default(0)
  latency      Int      @default(0)
  cacheHit     Boolean  @default(false)
  modelUsed    String   @default("gpt-3.5-turbo")
  quality      Int      @default(100)
  timestamp    DateTime @default(now())
  metadata     Json?
  feedback     AIQualityFeedback[]

  @@index([userId, timestamp])
  @@index([operation, timestamp])
  @@index([modelUsed, timestamp])
}

model AIUserQuota {
  id                 String   @id @default(cuid())
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier               String   @default("basic")
  dailyTokenLimit    Int      @default(10000)
  monthlyTokenLimit  Int      @default(250000)
  dailyUsedTokens    Int      @default(0)
  monthlyUsedTokens  Int      @default(0)
  dailyCost          Float    @default(0)
  monthlyCost        Float    @default(0)
  lastResetDaily     DateTime @default(now())
  lastResetMonthly   DateTime @default(now())
  isBlocked          Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model AIPerformanceMetric {
  id            String   @id @default(cuid())
  operation     String
  model         String
  avgLatency    Int      @default(0)
  avgCost       Float    @default(0)
  avgQuality    Int      @default(100)
  successRate   Float    @default(1.0)
  cacheHitRate  Float    @default(0.0)
  requestCount  Int      @default(0)
  totalTokens   Int      @default(0)
  date          DateTime
  createdAt     DateTime @default(now())

  @@unique([operation, model, date])
  @@index([date])
}

model AICacheEntry {
  id         String   @id @default(cuid())
  cacheKey   String   @unique
  operation  String
  prompt     String
  response   Json
  quality    Int      @default(100)
  hitCount   Int      @default(0)
  modelUsed  String
  tokenCount Int      @default(0)
  cost       Float    @default(0)
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  lastUsed   DateTime @default(now())

  @@index([operation])
  @@index([expiresAt])
}

model AIConfiguration {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  isActive    Boolean  @default(true)
  updatedBy   String
  updatedUser User     @relation(fields: [updatedBy], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AIQualityFeedback {
  id             String        @id @default(cuid())
  usageLogId     String
  usageLog       AIUsageLog    @relation(fields: [usageLogId], references: [id], onDelete: Cascade)
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating         Int           // 1-5 scale (validation handled in application)
  feedback       String?
  isHelpful      Boolean?
  reportedIssues String[]
  createdAt      DateTime      @default(now())
}
